<html>

<head>
    <style>
        .button {
            display: inline-block;
            width: 100px;
            height: 100px;
            color: #fff;
            background: #660;
        }
    </style>
</head>

<body>
    <h2>Triggers:</h2>
    <div class="holder">
    </div>
    <h2>Chute Position:</h2>
    <div class="chute_config">
    </div>
    <h2>Servo Ranges:</h2>
    <div class="servo_config">
    </div>
    <div class="dropper_config">
    </div>
    <script src="socket.io/socket.io.js"></script>
    <script src="jquery.js"></script>
    <script>
        const socket = io();

        $.getJSON("config.json", function(data) {
            var servos = data.servos;
            for (var i = 1; i <= 8; i++) {
                $('.holder').append($('<div class="button" data-id="' + i + '">' + i + '</div>').click(function(e) {
                    socket.emit("run", $(this).attr('data-id'));
                }));

                function doChangeFunc(i, v, s, t) {
                    socket.emit("config", {
                        "i": i,
                        "v": v,
                        "s": s,
                        "t": t,
                    });
                }

                var changeFunc = function(e) {
                    doChangeFunc($(this).attr('data-id'),
                                 $(this).val(),
                                 $(this).attr('data-side'),
                                 "chute");
                };
                
                if (i == 1) {
                    $('.chute_config').append($('<input type="button" value="Calibrate all"><br><br>').click(function(e) {
                        var startVal = document.getElementById("chuteconfig_left_1").value;
                        for (var i = 1; i <= 8; i++) {
                            var leftElem  = document.getElementById("chuteconfig_left_" + i);
                            var rightElem = document.getElementById("chuteconfig_right_" + i);
                            switch(i) {
                                case 1:
                                    rightElem.value = startVal - 4;
                                    break;
                                case 2:
                                    leftElem.value = startVal - 7;
                                    rightElem.value = startVal - 11;
                                    break;
                                case 3:
                                    leftElem.value = startVal - 16;
                                    rightElem.value = startVal - 20;
                                    break;
                                case 4:
                                    leftElem.value = startVal - 23;
                                    rightElem.value = startVal - 27;
                                    break;
                                case 5:
                                    leftElem.value = startVal - 30;
                                    rightElem.value = startVal - 34;
                                    break;
                                case 6:
                                    leftElem.value = startVal - 38;
                                    rightElem.value = startVal - 42;
                                    break;
                                case 7:
                                    leftElem.value = startVal - 46;
                                    rightElem.value = startVal - 50;
                                    break;
                                case 8:
                                    leftElem.value = startVal - 54;
                                    rightElem.value = startVal - 58;
                                    break;
                            }
                            doChangeFunc($(leftElem).attr('data-id'),
                                         $(leftElem).val(),
                                         $(leftElem).attr('data-side'),
                                         "chute");
                            doChangeFunc($(rightElem).attr('data-id'),
                                         $(rightElem).val(),
                                         $(rightElem).attr('data-side'),
                                         "chute");
                        }
                    }));
                }
                $('.chute_config').append(i + ': ').append($('<input class="chute_config_input" type="number" id="chuteconfig_left_' + i + '" placeholder="' + i + '" data-side="left" data-id="' + i + '" value="' + servos["chute"].positions[i].left + '" />').change(changeFunc)).append($('<input class="chute_config_input" type="number" id="chuteconfig_right_' + i + '" placeholder="' + i + '" data-side="right" data-id="' + i + '" value="' + servos["chute"].positions[i].right + '" /><br/>').change(changeFunc));

                var servo_config_change = function(e) {
                    socket.emit("config", {
                        "i": $(this).attr('data-id'),
                        "v": $(this).val(),
                        "t": "servo",
                        "p": $(this).attr('data-pos'),
                    });
                };
                $('.servo_config').append(i + ': ').append($('<input class="servo_config_input" type="number" data-pos="open" placeholder="' + i + '" data-id="' + i + '" value="' + servos[i].open + '" />').change(servo_config_change)).append(
                    $('<input class="servo_config_input" type="number" data-pos="close" placeholder="' + i + '" data-id="' + i + '" value="' + servos[i].close + '" /><br/>').change(servo_config_change));
            }
            $('.dropper_config').append('Dropper: ').append($('<input class="servo_config_input" type="number" data-pos="open" placeholder="dropper" data-id="dropper" value="' + servos["dropper"].open + '" />').change(servo_config_change)).append(
                $('<input class="servo_config_input" type="number" data-pos="close" placeholder="dropper" data-id="dropper" value="' + servos["dropper"].close + '" /><br/>').change(servo_config_change));

        });
    </script>
</body>

</html>


<!-- 
	Saveable Config control panel for servo distances.
	If light sensor blocked && ready
	    Open door
		Run servo to position
	    Drop Puck
	    If Light sensor 2 blocked || 10 seconds
	        Reset
            
    9x min - max
    1x 8 Positions
-->